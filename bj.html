<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blackjack Basic Strategy Trainer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        /* ADDED: Main wrapper for graphs + game */
        .dashboard-wrapper {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            width: 100%;
            max-width: 1600px; /* Allow space for graphs */
        }

        /* UPDATED: Graph dashboard container */
        .graph-dashboard {
            flex: 1; /* Take up available space */
            max-width: 500px; /* UPDATED: Increased width */
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #d4af37;
        }

        .graph-container {
            width: 100%;
        }

        .graph-container h2 {
            font-size: 1.2em;
            color: #d4af37;
            text-align: center;
            margin-bottom: 10px;
        }

        .game-container {
            background: linear-gradient(to bottom, #0a4d0a 0%, #0d6b0d 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 1000px;
            width: 100%;
            border: 3px solid #d4af37;
            flex-shrink: 0; /* Don't let game container shrink */
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #d4af37;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .options {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        @media (max-width: 768px) {
            /* UPDATED: Allow vertical stacking on small screens */
            .dashboard-wrapper {
                flex-direction: column;
                align-items: center;
            }
            .graph-dashboard {
                max-width: 100%;
                width: 100%;
                order: 2; /* Show graphs below game */
            }
            .game-container {
                order: 1; /* Show game on top */
            }
            
            .options {
                gap: 15px;
            }

            .slider-container {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 1400px) {
            /* UPDATED: Allow graphs to be a bit smaller on medium screens */
            .graph-dashboard {
                max-width: 400px;
            }
        }

        .options label {
            color: #d4af37;
            font-size: 1em;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .options input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #d4af37;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #d4af37;
            font-size: 1em;
        }

        .slider-container input[type="range"] {
            width: 120px;
            height: 6px;
            cursor: pointer;
            accent-color: #d4af37;
        }

        .slider-value {
            min-width: 40px;
            font-weight: bold;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(212, 175, 55, 0.3);
            color: #d4af37;
            font-size: 0.7em;
            font-weight: bold;
            cursor: help;
            margin-left: 4px;
        }

        .tooltip-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            padding: 8px 12px;
            background: rgba(0, 0, 0, 0.95);
            color: #d4af37;
            font-size: 0.85em;
            border-radius: 6px;
            white-space: nowrap;
            z-index: 1000;
            border: 1px solid #d4af37;
            pointer-events: none;
            max-width: 300px;
            white-space: normal;
            text-align: center;
        }

        .tooltip-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 2px;
            border: 6px solid transparent;
            border-top-color: #d4af37;
            z-index: 1000;
        }

        .stat-box {
            background: rgba(0,0,0,0.3);
            padding: 15px 25px;
            border-radius: 10px;
            border: 2px solid #d4af37;
            min-width: 150px;
        }

        .stat-label {
            color: #d4af37;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .stat-value {
            color: white;
            font-size: 1.5em;
            font-weight: bold;
        }

        .table {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 400px;
            position: relative;
        }

        .dealer-area, .player-area {
            margin-bottom: 30px;
        }

        .dealer-area, .player-area {
            text-align: center;
        }

        .area-label {
            color: #d4af37;
            font-size: 1.2em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .player-hands-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .player-hand-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            background: rgba(0,0,0,0.2);
            min-width: 200px;
        }

        .player-hand-wrapper.active {
            background: rgba(212, 175, 55, 0.2);
            border: 2px solid #d4af37;
        }

        .hand-label {
            color: #d4af37;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .hand {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            min-height: 140px;
            align-items: center;
            justify-content: center;
            position: relative;
            padding-top: 40px;
        }

        .card {
            width: 80px;
            height: 112px;
            background: white;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            font-size: 2em;
            font-weight: bold;
            position: relative;
            animation: dealCard 0.4s ease-out;
        }

        .card.horizontal {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%) rotate(90deg);
            animation: dealCardHorizontal 0.4s ease-out;
            z-index: 10;
        }

        @keyframes dealCard {
            from {
                transform: translateX(100vw) translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0) translateY(0);
                opacity: 1;
            }
        }

        @keyframes dealCardHorizontal {
            from {
                transform: translateX(calc(50vw - 50%)) translateY(-20px) rotate(90deg);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0) rotate(90deg);
                opacity: 1;
            }
        }

        .card.red {
            color: #dc143c;
        }

        .card.black {
            color: #000;
        }

        .card-back {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            font-size: 2.5em;
        }

        .hand-total {
            color: white;
            font-size: 1.3em;
            margin-top: 10px;
            font-weight: bold;
            background: rgba(0,0,0,0.4);
            padding: 5px 15px;
            border-radius: 5px;
            display: inline-block;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            min-width: 120px;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(to bottom, #d4af37 0%, #c5a028 100%);
            color: #000;
        }

        .btn-success {
            background: linear-gradient(to bottom, #28a745 0%, #218838 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(to bottom, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(to bottom, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(to bottom, #ffc107 0%, #e0a800 100%);
            color: #000;
        }

        .message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-size: 1.2em;
            font-weight: bold;
            animation: fadeIn 0.3s;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.success {
            background: rgba(40, 167, 69, 0.3);
            color: #90ee90;
            border: 2px solid #28a745;
        }

        .message.error {
            background: rgba(220, 53, 69, 0.3);
            color: #ff6b6b;
            border: 2px solid #dc3545;
        }

        .message.info {
            background: rgba(23, 162, 184, 0.3);
            color: #87ceeb;
            border: 2px solid #17a2b8;
        }

        .message.warning {
            background: rgba(255, 193, 7, 0.3);
            color: #ffd700;
            border: 2px solid #ffc107;
        }
        
        /* KO Deviation Styles */
        .deviation-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 15px;
            font-size: 0.85em;
        }
        
        .deviation-item {
            padding: 8px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 5px;
            color: #d4af37;
            transition: all 0.3s ease;
        }
        
        .deviation-item.deviation-active {
            background: rgba(212, 175, 55, 0.3);
            border-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
            font-weight: bold;
        }
        
        .deviation-item .deviation-threshold {
            float: right;
            opacity: 0.7;
            font-size: 0.9em;
        }
        
        /* Betting Chips Styles */
        .betting-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            border: 2px solid #d4af37;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .betting-label {
            color: #d4af37;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .chips-container {
            display: flex;
            gap: 8px;
        }
        
        .chip {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85em;
            border: 3px solid;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            user-select: none;
        }
        
        .chip:hover:not(.chip-disabled) {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        .chip:active:not(.chip-disabled) {
            transform: translateY(-1px);
        }
        
        .chip.chip-disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .chip-25 {
            background: linear-gradient(145deg, #2ecc71, #27ae60);
            border-color: #1e8449;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .chip-100 {
            background: linear-gradient(145deg, #2c3e50, #1a252f);
            border-color: #0f1419;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .chip-500 {
            background: linear-gradient(145deg, #9b59b6, #8e44ad);
            border-color: #6c3483;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .bet-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .current-bet-display {
            font-size: 1.3em;
            color: #d4af37;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            min-width: 80px;
            text-align: center;
        }
        
        .bet-action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .clear-bet-btn {
            background: #e74c3c;
            color: white;
        }
        
        .clear-bet-btn:hover {
            background: #c0392b;
        }
        
        .clear-bet-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Betting Ramp Configurator */
        .betting-ramp-config {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.4);
            border-radius: 8px;
            border: 2px solid #d4af37;
            display: none;
        }
        
        .betting-ramp-config.visible {
            display: block;
        }
        
        .config-header {
            color: #d4af37;
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .ramp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }
        
        .ramp-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 5px;
        }
        
        .ramp-label {
            color: #d4af37;
            font-size: 0.9em;
            min-width: 60px;
        }
        
        .ramp-input {
            width: 60px;
            padding: 4px;
            border: 1px solid #d4af37;
            background: rgba(0,0,0,0.5);
            color: #d4af37;
            border-radius: 4px;
            font-size: 0.9em;
            text-align: center;
        }
        
        .ramp-suffix {
            color: #d4af37;
            font-size: 0.85em;
            opacity: 0.8;
        }
        
        .config-toggle-btn {
            width: 100%;
            padding: 8px;
            margin-top: 10px;
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            color: #d4af37;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        
        .config-toggle-btn:hover {
            background: rgba(212, 175, 55, 0.3);
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .shake {
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .strategy-hint {
            background: rgba(0,0,0,0.3);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            color: #d4af37;
            font-size: 0.95em;
            text-align: center;
        }

        @media (max-width: 768px) {
            .game-container {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .card {
                width: 60px;
                height: 84px;
                font-size: 1.5em;
            }

            button {
                padding: 12px 20px;
                font-size: 1em;
                min-width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        
        <div class="graph-dashboard">
            <div class="graph-container">
                <h2>Session Variance</h2>
                <canvas id="session-variance-chart"></canvas>
            </div>
            
            <div class="graph-container">
                <h2>KO Count</h2>
                <div style="display: flex; flex-direction: column; align-items: center; gap: 15px; padding: 20px;">
                    <div style="font-size: 3.5em; font-weight: bold; color: #d4af37; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);" id="ko-count">-20</div>
                    <div style="width: 100%; max-width: 300px;">
                        <div style="font-size: 0.9em; color: #d4af37; margin-bottom: 5px; text-align: center;">Shoe Penetration</div>
                        <div style="width: 100%; height: 20px; background: rgba(0,0,0,0.3); border-radius: 10px; border: 1px solid #d4af37; overflow: hidden;">
                            <div id="shoe-penetration-fill" style="height: 100%; width: 0%; background: #4CAF50; transition: width 0.3s ease;"></div>
                        </div>
                    </div>
                    
                    <div style="width: 100%; max-width: 300px;">
                        <div style="font-size: 0.9em; color: #d4af37; margin-bottom: 8px; text-align: center; font-weight: bold;">Index Plays</div>
                        <div class="deviation-list">
                            <div class="deviation-item" id="dev-16v10">
                                16 vs 10 (Stand)
                                <span class="deviation-threshold">-6</span>
                            </div>
                            <div class="deviation-item" id="dev-11vA">
                                11 vs A (Double)
                                <span class="deviation-threshold">-6</span>
                            </div>
                            <div class="deviation-item" id="dev-13v2">
                                13 vs 2 (Stand)
                                <span class="deviation-threshold">-6</span>
                            </div>
                            <div class="deviation-item" id="dev-12v4">
                                12 vs 4 (Stand)
                                <span class="deviation-threshold">-6</span>
                            </div>
                            <div class="deviation-item" id="dev-insurance">
                                Insurance
                                <span class="deviation-threshold">+3</span>
                            </div>
                            <div class="deviation-item" id="dev-15v10">
                                15 vs 10 (Stand)
                                <span class="deviation-threshold">+4</span>
                            </div>
                            <div class="deviation-item" id="dev-10v10">
                                10 vs 10 (Double)
                                <span class="deviation-threshold">+4</span>
                            </div>
                            <div class="deviation-item" id="dev-10vA">
                                10 vs A (Double)
                                <span class="deviation-threshold">+4</span>
                            </div>
                            <div class="deviation-item" id="dev-12v2">
                                12 vs 2 (Stand)
                                <span class="deviation-threshold">+4</span>
                            </div>
                            <div class="deviation-item" id="dev-12v3">
                                12 vs 3 (Stand)
                                <span class="deviation-threshold">+4</span>
                            </div>
                            <div class="deviation-item" id="dev-9v2">
                                9 vs 2 (Double)
                                <span class="deviation-threshold">+4</span>
                            </div>
                            <div class="deviation-item" id="dev-9v7">
                                9 vs 7 (Double)
                                <span class="deviation-threshold">+4</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="game-container">
            <div class="header">
                <h1>‚ô†Ô∏è Blackjack Basic Strategy Trainer ‚ô•Ô∏è</h1>
            </div>

            <div class="stats">
                <div class="stat-box">
                    <div class="stat-label">Bankroll</div>
                    <div class="stat-value" id="bankroll">$10,000</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Current Bet</div>
                    <div class="stat-value" id="current-bet">$100</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Hands Played</div>
                    <div class="stat-value" id="hands-played">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Correct Plays</div>
                    <div class="stat-value" id="correct-plays">0 / 0</div>
                </div>
            </div>

            <div class="options">
                <label>
                    <input type="checkbox" id="auto-deal-checkbox" onchange="toggleAutoDeal()">
                    Auto Deal
                </label>
                <label>
                    <input type="checkbox" id="auto-play-checkbox" onchange="toggleAutoPlay()">
                    Auto Play Easy Hands
                    <span class="tooltip-icon" data-tooltip="Auto stands: Hard 17-21 ‚Ä¢ Soft 20 (A,9) ‚Ä¢ Soft 19 (A,8) vs non-6 ‚Ä¢ Auto splits: A,A ‚Ä¢ Auto surrender: 16 vs 9/T/A, 15 vs T">?</span>
                </label>
                <label>
                    <input type="checkbox" id="auto-play-medium-checkbox" onchange="toggleAutoPlayMedium()">
                    Auto Play Medium Hands
                    <span class="tooltip-icon" data-tooltip="Auto stands: Hard 13-16 vs dealer 2-6 (excludes pairs)">?</span>
                </label>
                <label>
                    <input type="checkbox" id="auto-play-hits-checkbox" onchange="toggleAutoPlayHits()">
                    Auto Play Hits
                    <span class="tooltip-icon" data-tooltip="Auto hits all hard 16 or less vs dealer 7-Ace (if not a double/split).">?</span>
                </label>
                <label>
                    <input type="checkbox" id="hide-totals-checkbox" onchange="toggleHideTotals()">
                    Hide Totals
                </label>
                <label>
                    <input type="checkbox" id="betting-preset-checkbox" onchange="toggleBettingPreset()">
                    KO Betting Preset
                    <span class="tooltip-icon" data-tooltip="Automatically sizes bets based on KO running count using optimal betting ramp">?</span>
                </label>
                <div class="slider-container" id="unit-size-container" style="display: none;">
                    <label for="unit-size-input">Unit Size: $</label>
                    <input type="number" id="unit-size-input" min="25" max="1000" step="25" value="100" 
                           oninput="updateUnitSize()" 
                           style="width: 80px; padding: 4px; border: 1px solid #d4af37; background: rgba(0,0,0,0.5); color: #d4af37; border-radius: 4px;">
                </div>
            </div>
            
            <div class="betting-ramp-config" id="betting-ramp-config">
                <div class="config-header">Betting Ramp Configuration</div>
                <div class="ramp-grid">
                    <div class="ramp-item">
                        <span class="ramp-label">RC ‚â§ -5:</span>
                        <input type="number" class="ramp-input" id="ramp-rc-5" min="1" max="50" value="1" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC -4:</span>
                        <input type="number" class="ramp-input" id="ramp-rc-4" min="1" max="50" value="2" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC -3:</span>
                        <input type="number" class="ramp-input" id="ramp-rc-3" min="1" max="50" value="3" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC -2:</span>
                        <input type="number" class="ramp-input" id="ramp-rc-2" min="1" max="50" value="4" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC -1:</span>
                        <input type="number" class="ramp-input" id="ramp-rc-1" min="1" max="50" value="6" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC 0:</span>
                        <input type="number" class="ramp-input" id="ramp-rc0" min="1" max="50" value="8" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC +1:</span>
                        <input type="number" class="ramp-input" id="ramp-rc1" min="1" max="50" value="10" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                    <div class="ramp-item">
                        <span class="ramp-label">RC ‚â• +2:</span>
                        <input type="number" class="ramp-input" id="ramp-rc2" min="1" max="50" value="12" onchange="updateBettingRamp()">
                        <span class="ramp-suffix">units</span>
                    </div>
                </div>
                <button class="config-toggle-btn" onclick="toggleRampConfig()">Hide Configuration</button>
            </div>
            
            <div class="options">
                <div class="slider-container">
                    <label for="redeal-speed-slider">Redeal Speed:</label>
                    <input type="range" id="redeal-speed-slider" min="0" max="4000" step="500" value="2000" oninput="updateRedealSpeed()">
                    <span class="slider-value" id="slider-value">2.0s</span>
                </div>
            </div>

            <div class="message info" id="message">
                Click "New Hand" to start playing!
            </div>

            <div class="table">
                <div class="dealer-area">
                    <div class="area-label">Dealer</div>
                    <div class="hand" id="dealer-hand"></div>
                    <div class="hand-total" id="dealer-total" style="visibility: hidden;">0</div>
                </div>

                <div class="player-area">
                    <div class="area-label">Player</div>
                    <div class="player-hands-container" id="player-hands-container"></div>
                </div>
            </div>

            <div class="betting-controls">
                <div class="betting-label">Bet:</div>
                <div class="chips-container">
                    <div class="chip chip-25" onclick="addChipToBet(25)" id="chip-25">$25</div>
                    <div class="chip chip-100" onclick="addChipToBet(100)" id="chip-100">$100</div>
                    <div class="chip chip-500" onclick="addChipToBet(500)" id="chip-500">$500</div>
                </div>
                <div class="current-bet-display" id="current-bet-amount">$100</div>
                <button class="bet-action-btn clear-bet-btn" onclick="clearBet()" id="clear-bet-btn">Clear</button>
            </div>

            <div class="controls">
                <button class="btn-primary" id="new-hand-btn" onclick="startNewHand()">New Hand</button>
                <button class="btn-success" id="hit-btn" onclick="playerAction('hit')" disabled>Hit</button>
                <button class="btn-danger" id="stand-btn" onclick="playerAction('stand')" disabled>Stand</button>
                <button class="btn-warning" id="double-btn" onclick="playerAction('double')" disabled>Double</button>
                <button class="btn-info" id="split-btn" onclick="playerAction('split')" disabled>Split</button>
            </div>

            <div class="strategy-hint" id="strategy-hint" style="display: none;">
                Correct play will be shown here after you make your choice
            </div>
        </div>
    </div> <script>
        // Game state
        let deck = [];
        let playerHands = []; // Array of hands (for splits)
        let dealerHand = [];
        let currentHandIndex = 0;
        let bankroll = 10000;
        let currentBet = 100;
        let handsPlayed = 0;
        let correctPlays = 0;
        let totalDecisions = 0;
        let gameActive = false;
        let canDouble = false;
        let canSplit = false;
        let awaitingFirstAction = false;
        let displayedDealerCards = 0;
        let autoDealEnabled = false;
        let autoPlayEasyHands = false;
        let autoPlayMediumHands = false;
        let autoPlayHits = false;
        let hideTotals = false;
        let redealSpeed = 2000; // milliseconds
        let splitAces = false; // Track if we split aces
        let handWrappers = []; // Track DOM elements for each hand
        
        // KO Counting System Variables
        let koRunningCount = -20; // Starting IRC for 6 decks
        let cutCardPosition = 0; // Position in deck where cut card is placed
        let cardsDealt = 0; // Track how many cards have been dealt from shoe
        let totalCardsInShoe = 312; // 6 decks = 312 cards
        
        // Betting Preset System
        let bettingPresetEnabled = false;
        let unitSize = 100; // Default unit size in dollars
        // Default 6-deck KO betting ramp: [runningCount, unitMultiplier]
        let bettingRamp = [
            { rc: -5, units: 1 },
            { rc: -4, units: 2 },
            { rc: -3, units: 3 },
            { rc: -2, units: 4 },
            { rc: -1, units: 6 },
            { rc: 0, units: 8 },
            { rc: 1, units: 10 },
            { rc: 2, units: 12 }
        ];

        // Card suits and values
        const suits = ['‚ô†', '‚ô•', '‚ô¶', '‚ô£'];
        const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
        const valueMap = {'A': 11, '2': 2, '3': 3, '4': 4, '5': 5, '6': 6, '7': 7, '8': 8, '9': 9, '10': 10, 'J': 10, 'Q': 10, 'K': 10};
        
        // --- ADDED: Graphing and EV State ---
        let cumulativeEV = 0;
        let cumulativeProfit = 0;
        let currentHandInitialEV = 0; // Stores the $EV of the initial hand
        let sessionVarianceChart; // UPDATED: Removed handOutcomeChart

        // The EV table, transcribed from Wizard of Odds data for 6D, H17, DAS
        // Values are the EV of the *best possible play* for that situation.
        const evTable = {
            "hard": {
                "5":  { "2": -0.126025, "3": -0.093202, "4": -0.055370, "5": -0.015690, "6": 0.019256,  "7": -0.119481, "8": -0.187166, "9": -0.265989, "10": -0.312725, "A": -0.292671 },
                "6":  { "2": -0.139226, "3": -0.105892, "4": -0.067021, "5": -0.026775, "6": -0.009881, "7": -0.153746, "8": -0.219720, "9": -0.294528, "10": -0.339101, "A": -0.344327 },
                "7":  { "2": -0.110920, "3": -0.076982, "4": -0.038414, "5": 0.001535,  "6": 0.035824,  "7": -0.069120, "8": -0.213278, "9": -0.288453, "10": -0.321535, "A": -0.353382 },
                "8":  { "2": -0.023176, "3": 0.008067,  "4": 0.044637,  "5": 0.080817,  "6": 0.111453,  "7": 0.083844,  "8": -0.059455, "9": -0.211386, "10": -0.249600, "A": -0.263885 },
                "9":  { "2": 0.075786,  "3": 0.131414,  "4": 0.197964,  "5": 0.268497,  "6": 0.324478,  "7": 0.176299,  "8": 0.099920,  "9": -0.052189, "10": -0.150592, "A": -0.124191 },
                "10": { "2": 0.187678,  "3": 0.268158,  "4": 0.368992,  "5": 0.485545,  "6": 0.535069,  "7": 0.469748,  "8": 0.353456,  "9": 0.230031,  "10": 0.027154,  "A": 0.034616  },
                "11": { "2": 0.371112,  "3": 0.423861,  "4": 0.479387,  "5": 0.539658,  "6": 0.587547,  "7": 0.404746,  "8": 0.293033,  "9": 0.149188,  "10": -0.004071, "A": -0.025588 },
                "12": { "2": -0.281702, "3": -0.240493, "4": -0.196879, "5": -0.154527, "6": -0.121827, "7": -0.476858, "8": -0.513537, "9": -0.542861, "10": -0.538594, "A": -0.594466 },
                "13": { "2": -0.282213, "3": -0.240992, "4": -0.197610, "5": -0.158476, "6": -0.122651, "7": -0.478433, "8": -0.515221, "9": -0.544695, "10": -0.539184, "A": -0.593566 },
                "14": { "2": -0.282722, "3": -0.241518, "4": -0.198315, "5": -0.162425, "6": -0.123475, "7": -0.479132, "8": -0.515767, "9": -0.545528, "10": -0.535586, "A": -0.592673 },
                "15": { "2": -0.283230, "3": -0.242197, "4": -0.202241, "5": -0.163247, "6": -0.124186, "7": -0.479635, "8": -0.516638, "9": -0.541376, "10": -0.536220, "A": -0.503074 },
                "16": { "2": -0.283912, "3": -0.246129, "4": -0.203055, "5": -0.163962, "6": -0.124822, "7": -0.480503, "8": -0.516050, "9": -0.541961, "10": -0.534676, "A": -0.538656 },
                "17": { "2": -0.157192, "3": -0.120447, "4": -0.080830, "5": -0.045986, "6": -0.009816, "7": -0.478380, "8": -0.500967, "9": -0.549404, "10": -0.580066, "A": -0.578940 },
                "18": { "2": 0.109693,  "3": 0.137849,  "4": 0.164363,  "5": 0.195534,  "6": 0.220261,  "7": -0.108885, "8": -0.384233, "9": -0.612833, "10": -0.643745, "A": -0.639911 },
                "19": { "2": 0.377921,  "3": 0.394037,  "4": 0.413067,  "5": 0.437502,  "6": 0.450523,  "7": 0.615047,  "8": 0.591091,  "9": 0.283901,  "10": 0.069444,  "A": 0.191966  },
                "20": { "2": 0.632910,  "3": 0.643634,  "4": 0.654267,  "5": 0.668927,  "6": 0.676590,  "7": 0.772011,  "8": 0.790420,  "9": 0.756075,  "10": 0.559145, "A": 0.600344  },
                "21": { "2": 0.880850,  "3": 0.887820,  "4": 0.894790,  "5": 0.904890,  "6": 0.910380,  "7": 0.850445,  "8": 0.847142,  "9": 0.849438,  "10": 0.847142, "A": 0.108590  } // 10,A is BJ
            },
            "soft": {
                "13": { "2": 0.045611,  "3": 0.073770,  "4": 0.104348,  "5": 0.141030,  "6": 0.166485,  "7": 0.120174,  "8": 0.051835,  "9": -0.034089, "10": -0.102303, "A": -0.100433 },
                "14": { "2": 0.022101,  "3": 0.050358,  "4": 0.082777,  "5": 0.139629,  "6": 0.189536,  "7": 0.076540,  "8": 0.016478,  "9": -0.072746, "10": -0.137094, "A": -0.135170 },
                "15": { "2": -0.000918, "3": 0.029075,  "4": 0.065278,  "5": 0.130267,  "6": 0.202017,  "7": 0.036406,  "8": -0.028404, "9": -0.112418, "10": -0.173213, "A": -0.172032 },
                "16": { "2": -0.021446, "3": 0.008338,  "4": 0.061535,  "5": 0.130267,  "6": 0.202017,  "7": -0.007882, "8": -0.069392, "9": -0.151418, "10": -0.210080, "A": -0.209173 },
                "17": { "2": -0.000274, "3": 0.057176,  "4": 0.123295,  "5": 0.197379,  "6": 0.252146,  "7": 0.054706,  "8": -0.071750, "9": -0.147268, "10": -0.195609, "A": -0.221401 },
                "18": { "2": 0.116262,  "3": 0.175215,  "4": 0.244794,  "5": 0.302263,  "6": 0.356906,  "7": 0.171872,  "8": 0.041028,  "9": -0.098469, "10": -0.142912, "A": -0.160455 },
                "19": { "2": 0.380751,  "3": 0.399787,  "4": 0.415570,  "5": 0.439914,  "6": 0.462089,  "7": 0.220956,  "8": 0.152904,  "9": 0.007442,  "10": -0.087616, "A": -0.064654 },
                "20": { "2": 0.637642,  "3": 0.645253,  "4": 0.655844,  "5": 0.670408,  "6": 0.677574,  "7": 0.773273,  "8": 0.790658,  "9": 0.759490,  "10": 0.554555, "A": 0.030489  },
                "21": { "2": 0.472562,  "3": 0.520285,  "4": 0.570259,  "5": 0.622136,  "6": 0.667063,  "7": 0.463763,  "8": 0.347788,  "9": 0.225894,  "10": 0.173198, "A": 1.5       } // 10,A is BJ
            },
            "pairs": {
                "A": { "2": 0.485375,  "3": 0.532737,  "4": 0.582300,  "5": 0.633712,  "6": 0.679649,  "7": 0.475600,  "8": 0.359708,  "9": 0.237754,  "10": 0.181988,  "A": 0.120987  },
                "2": { "2": 0.078280,  "3": 0.073362,  "4": 0.176577,  "5": 0.268018,  "6": 0.008597,  "7": -0.176794, "8": -0.237873, "9": -0.287099, "10": -0.522035, "A": -0.153905 },
                "3": { "2": -0.129464, "3": -0.046145, "4": 0.054585,  "5": 0.156799,  "6": 0.247426,  "7": -0.051101, "8": -0.230664, "9": -0.431618, "10": -0.546375, "A": -0.566417 },
                "4": { "2": -0.181576, "3": -0.088408, "4": 0.010058,  "5": 0.114847,  "6": 0.207228,  "7": -0.168774, "8": -0.325801, "9": -0.508478, "10": -0.619294, "A": -0.636420 },
                "5": { "2": 0.187678,  "3": 0.268158,  "4": 0.368992,  "5": 0.485545,  "6": 0.535069,  "7": 0.469748,  "8": 0.353456,  "9": 0.230031,  "10": 0.027154,  "A": 0.034616  }, // Never split 5s, treat as Hard 10
                "6": { "2": -0.190104, "3": -0.092792, "4": 0.010721,  "5": 0.115525,  "6": 0.191888,  "7": -0.252905, "8": -0.416429, "9": -0.602063, "10": -0.707854, "A": -0.726030 },
                "7": { "2": -0.120233, "3": -0.028565, "4": 0.072938,  "5": 0.160565,  "6": 0.249820,  "7": -0.048567, "8": -0.390952, "9": -0.573526, "10": -0.652075, "A": -0.728559 },
                "8": { "2": 0.074691,  "3": 0.148354,  "4": 0.218242,  "5": 0.301452,  "6": 0.373881,  "7": 0.318876,  "8": -0.029242, "9": -0.389950, "10": -0.475385, "A": -0.514318 },
                "9": { "2": 0.195080,  "3": 0.249871,  "4": 0.319011,  "5": 0.393253,  "6": 0.453097,  "7": 0.334523,  "8": 0.229929,  "9": -0.081564, "10": -0.309996, "A": -0.240949 },
                "10":{ "2": 0.632910,  "3": 0.643634,  "4": 0.654267,  "5": 0.668927,  "6": 0.676590,  "7": 0.772011,  "8": 0.790420,  "9": 0.756075,  "10": 0.559145, "A": 0.600344  } // Never split 10s
            }
        };
        // --- END: Graphing and EV State ---


        // Initialize deck
        function createDeck() {
            deck = [];
            // Create 6-deck shoe (312 cards)
            for (let i = 0; i < 6; i++) {
                for (let suit of suits) {
                    for (let value of values) {
                        deck.push({value, suit, numValue: valueMap[value]});
                    }
                }
            }
            shuffleDeck();
            
            // Place cut card randomly between 4.5-5 decks deep (234-260 cards dealt out of 312)
            // This leaves 1-1.5 decks undealt, like a real casino
            const minCutCard = 234; // 4.5 decks
            const maxCutCard = 260; // 5 decks
            cutCardPosition = Math.floor(Math.random() * (maxCutCard - minCutCard + 1)) + minCutCard;
            
            // Reset card tracking and KO count
            cardsDealt = 0;
            koRunningCount = -20; // Reset to IRC for 6 decks
            totalCardsInShoe = 312;
            
            updateKODisplay();
        }

        function shuffleDeck() {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
        }

        function dealCard(countImmediately = true) {
            // Check if we've reached the cut card - if so, shuffle after this hand completes
            if (cardsDealt >= cutCardPosition && !gameActive) {
                showMessage('Cut card reached! Shuffling new shoe...', 'info');
                createDeck();
            }
            
            // If deck is somehow empty (shouldn't happen with cut card), create new deck
            if (deck.length === 0) {
                createDeck();
            }
            
            const card = deck.pop();
            cardsDealt++;
            
            // Update KO count based on card value (only if countImmediately is true)
            if (countImmediately) {
                updateKOCount(card);
            }
            
            return card;
        }
        
        // Update the KO running count based on card dealt
        function updateKOCount(card) {
            const value = card.value;
            
            // KO System: 2-7 = +1, 8-9 = 0, T-A = -1
            if (['2', '3', '4', '5', '6', '7'].includes(value)) {
                koRunningCount += 1;
            } else if (['10', 'J', 'Q', 'K', 'A'].includes(value)) {
                koRunningCount -= 1;
            }
            // 8 and 9 don't change the count (0)
            
            updateKODisplay();
        }
        
        // Update the KO counter display
        function updateKODisplay() {
            const countElement = document.getElementById('ko-count');
            if (countElement) {
                countElement.textContent = koRunningCount >= 0 ? '+' + koRunningCount : koRunningCount;
            }
            
            // Update shoe penetration display
            updateShoePenetration();
            
            // Update preset bet if enabled and not in active game
            if (bettingPresetEnabled && !gameActive) {
                updatePresetBet();
            }
        }
        
        // Update the shoe penetration visual
        function updateShoePenetration() {
            const penetrationElement = document.getElementById('shoe-penetration-fill');
            if (penetrationElement) {
                const penetrationPercent = (cardsDealt / cutCardPosition) * 100;
                penetrationElement.style.width = Math.min(penetrationPercent, 100) + '%';
            }
            
            // Update deviation highlighting
            updateDeviationHighlights();
        }
        
        // Highlight deviations that are now applicable based on current KO count
        function updateDeviationHighlights() {
            const deviations = [
                { id: 'dev-insurance', threshold: 3 },
                { id: 'dev-16v10', threshold: -6 },
                { id: 'dev-15v10', threshold: 4 },
                { id: 'dev-10v10', threshold: 4 },
                { id: 'dev-10vA', threshold: 4 },
                { id: 'dev-12v2', threshold: 4 },
                { id: 'dev-12v3', threshold: 4 },
                { id: 'dev-11vA', threshold: -6 },
                { id: 'dev-13v2', threshold: -6 },
                { id: 'dev-9v2', threshold: 4 },
                { id: 'dev-9v7', threshold: 4 },
                { id: 'dev-12v4', threshold: -6 }
            ];
            
            deviations.forEach(dev => {
                const element = document.getElementById(dev.id);
                if (element) {
                    if (koRunningCount >= dev.threshold) {
                        element.classList.add('deviation-active');
                    } else {
                        element.classList.remove('deviation-active');
                    }
                }
            });
        }

        // Calculate hand value
        function calculateHand(hand) {
            let total = 0;
            let aces = 0;

            for (let card of hand) {
                total += card.numValue;
                if (card.value === 'A') aces++;
            }

            while (total > 21 && aces > 0) {
                total -= 10;
                aces--;
            }

            return {total, soft: aces > 0 && total <= 21};
        }

        // Display cards
        function displayCard(card, container, faceDown = false, horizontal = false) {
            const cardDiv = document.createElement('div');
            const colorClass = (card.suit === '‚ô•' || card.suit === '‚ô¶' ? 'red' : 'black');
            cardDiv.className = `card ${faceDown ? 'card-back' : colorClass} ${horizontal ? 'horizontal' : ''}`;
            
            if (!faceDown) {
                cardDiv.textContent = `${card.value}${card.suit}`;
            } else {
                cardDiv.textContent = 'üÇ†';
            }
            
            container.appendChild(cardDiv);
        }

        function updateDisplay() {
            const dealerHandDiv = document.getElementById('dealer-hand');
            const playerHandsContainer = document.getElementById('player-hands-container');
            
            // Only add new dealer cards
            for (let i = displayedDealerCards; i < dealerHand.length; i++) {
                displayCard(dealerHand[i], dealerHandDiv, i === 1 && gameActive);
            }
            displayedDealerCards = dealerHand.length;

            // If game is no longer active and dealer's second card is face down, reveal it
            if (!gameActive && dealerHandDiv.children.length >= 2) {
                const secondCard = dealerHandDiv.children[1];
                if (secondCard.classList.contains('card-back')) {
                    const card = dealerHand[1];
                    secondCard.className = `card ${card.suit === '‚ô•' || card.suit === '‚ô¶' ? 'red' : 'black'}`;
                    secondCard.textContent = `${card.value}${card.suit}`;
                    // Count the hole card now that it's revealed
                    updateKOCount(card);
                }
            }

            // Update dealer total
            const dealerCalc = calculateHand([dealerHand[0]]);
            const dealerTotalDiv = document.getElementById('dealer-total');
            dealerTotalDiv.textContent = gameActive ? `${dealerCalc.total}` :
                (() => {
                    const fullDealerCalc = calculateHand(dealerHand);
                    return fullDealerCalc.soft ? `${fullDealerCalc.total} (Soft)` : fullDealerCalc.total;
                })();
            dealerTotalDiv.style.visibility = hideTotals ? 'hidden' : 'visible';

            // Create or update player hand wrappers
            playerHands.forEach((hand, handIndex) => {
                let wrapper = handWrappers[handIndex];
                
                // Create wrapper if it doesn't exist
                if (!wrapper) {
                    wrapper = document.createElement('div');
                    wrapper.className = 'player-hand-wrapper';
                    
                    if (playerHands.length > 1) {
                        const label = document.createElement('div');
                        label.className = 'hand-label';
                        label.textContent = `Hand ${handIndex + 1}`;
                        wrapper.appendChild(label);
                    }
                    
                    const handDiv = document.createElement('div');
                    handDiv.className = 'hand';
                    wrapper.appendChild(handDiv);
                    
                    const totalDiv = document.createElement('div');
                    totalDiv.className = 'hand-total';
                    wrapper.appendChild(totalDiv);
                    
                    playerHandsContainer.appendChild(wrapper);
                    handWrappers[handIndex] = wrapper;
                    hand.displayedCards = 0;
                }
                
                // Update active state
                if (handIndex === currentHandIndex && gameActive) {
                    wrapper.classList.add('active');
                } else {
                    wrapper.classList.remove('active');
                }
                
                // Add only new cards
                const handDiv = wrapper.querySelector('.hand');
                for (let i = hand.displayedCards || 0; i < hand.cards.length; i++) {
                    const isDoubledCard = (i === hand.doubledCardIndex);
                    displayCard(hand.cards[i], handDiv, false, isDoubledCard);
                }
                hand.displayedCards = hand.cards.length;
                
                // Update total
                const totalDiv = wrapper.querySelector('.hand-total');
                const calc = calculateHand(hand.cards);
                totalDiv.textContent = calc.soft ? `${calc.total} (Soft)` : calc.total;
                totalDiv.style.color = 'white';
                totalDiv.style.visibility = hideTotals ? 'hidden' : 'visible';
                
                if (hand.surrendered) {
                    totalDiv.textContent += ' - SURRENDER';
                    totalDiv.style.color = '#ffa500';
                } else if (hand.busted) {
                    totalDiv.textContent += ' - BUST';
                    totalDiv.style.color = '#ff6b6b';
                } else if (hand.stood) {
                    totalDiv.style.color = '#90ee90';
                } else if (hand.blackjack) {
                    totalDiv.textContent = '21 - BLACKJACK';
                    totalDiv.style.color = '#ffd700';
                }
            });
        }

        // Basic Strategy Logic
        // Following H17 Basic Strategy (dealer hits soft 17)
        // DAS (Double After Split) is enabled - you can double on split hands
        function getCorrectAction() {
            const currentHand = playerHands[currentHandIndex];
            const playerCalc = calculateHand(currentHand.cards);
            const dealerUpCard = dealerHand[0].value;
            const dealerValue = dealerHand[0].numValue === 11 ? 'A' : dealerHand[0].numValue;

            // Check for pair
            if (canSplit && currentHand.cards.length === 2 && currentHand.cards[0].value === currentHand.cards[1].value) {
                const pairValue = currentHand.cards[0].value;
                if (shouldSplit(pairValue, dealerValue)) {
                    return 'split';
                }
            }

            // Check for soft hand
            if (playerCalc.soft && playerCalc.total >= 12) {
                return getSoftAction(playerCalc.total, dealerValue);
            }

            // Hard hand
            return getHardAction(playerCalc.total, dealerValue);
        }

        function shouldSplit(pairValue, dealerValue) {
            // Pair splitting chart WITH DAS (Double After Split) - treating Y/N as Y
            const splitChart = {
                'A': [2,3,4,5,6,7,8,9,10,'A'],  // Always split aces
                'K': [], 'Q': [], 'J': [], '10': [],  // Never split 10s
                '9': [2,3,4,5,6,8,9],  // Split vs 2-6,8,9 (not vs 7,10,A)
                '8': [2,3,4,5,6,7,8,9,10,'A'],  // Always split 8s
                '7': [2,3,4,5,6,7],  // Split vs 2-7
                '6': [2,3,4,5,6],  // Split vs 2-6 (with DAS)
                '5': [],  // Never split 5s
                '4': [5,6],  // Split vs 5-6 only (with DAS)
                '3': [2,3,4,5,6,7],  // Split vs 2-7 (with DAS)
                '2': [2,3,4,5,6,7]  // Split vs 2-7 (with DAS)
            };

            return splitChart[pairValue]?.includes(dealerValue) || false;
        }

        function getSoftAction(total, dealerValue) {
            // Soft totals strategy - following the chart EXACTLY
            if (total === 21 || total === 20) return 'stand'; // A,9
            
            if (total === 19) { // A,8
                // Ds Ds Ds Ds Ds S S S S S
                if ([2,3,4,5,6].includes(dealerValue) && canDouble) return 'double';
                return 'stand';
            }
            
            if (total === 18) { // A,7
                // Ds Ds Ds Ds Ds S S H H H
                if ([2,3,4,5,6].includes(dealerValue) && canDouble) return 'double';
                if ([2,3,4,5,6,7,8].includes(dealerValue)) return 'stand';
                return 'hit'; // vs 9, 10, A
            }
            
            if (total === 17) { // A,6
                // H D D D D H H H H H
                if ([3,4,5,6].includes(dealerValue) && canDouble) return 'double';
                return 'hit';
            }
            
            if (total === 16 || total === 15) { // A,5 or A,4
                // H H D D D H H H H H
                if ([4,5,6].includes(dealerValue) && canDouble) return 'double';
                return 'hit';
            }
            
            if (total === 14 || total === 13) { // A,3 or A,2
                // H H H D D H H H H H
                if ([5,6].includes(dealerValue) && canDouble) return 'double';
                return 'hit';
            }
            
            return 'hit';
        }

        function getHardAction(total, dealerValue) {
            // Hard totals strategy - following the chart EXACTLY
            if (total >= 17) return 'stand';
            
            if (total >= 13 && total <= 16) {
                // Stand vs 2-6, hit vs 7+
                return [2,3,4,5,6].includes(dealerValue) ? 'stand' : 'hit';
            }
            
            if (total === 12) {
                // Hit vs 2-3, stand vs 4-6, hit vs 7+
                return [4,5,6].includes(dealerValue) ? 'stand' : 'hit';
            }
            
            if (total === 11) {
                // Always double if allowed
                return canDouble ? 'double' : 'hit';
            }
            
            if (total === 10) {
                // Double vs 2-9, hit vs 10,A
                return ([2,3,4,5,6,7,8,9].includes(dealerValue) && canDouble) ? 'double' : 'hit';
            }
            
            if (total === 9) {
                // Hit vs 2, double vs 3-6, hit vs 7+
                return ([3,4,5,6].includes(dealerValue) && canDouble) ? 'double' : 'hit';
            }
            
            // 8 or less: always hit
            return 'hit';
        }

        // Sound effects using Web Audio API
        function playSound(frequency, duration) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = frequency;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }

        function playCorrectSound() {
            playSound(800, 0.1);
            setTimeout(() => playSound(1000, 0.15), 100);
        }

        function playWinSound() {
            playSound(523, 0.1);
            setTimeout(() => playSound(659, 0.1), 100);
            setTimeout(() => playSound(784, 0.2), 200);
        }

        // Show message
        function showMessage(text, type = 'info') {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `message ${type}`;
            messageDiv.classList.add('pulse');
            setTimeout(() => messageDiv.classList.remove('pulse'), 500);
        }

        // Start new hand
        function startNewHand() {
            if (currentBet === 0) {
                showMessage('Please place a bet first!', 'warning');
                return;
            }
            
            if (bankroll < currentBet) {
                showMessage('Not enough money! Game Over. Refresh to restart.', 'error');
                document.getElementById('new-hand-btn').disabled = true;
                document.getElementById('auto-deal-checkbox').disabled = true;
                return;
            }

            playerHands = [{
                cards: [], 
                busted: false, 
                stood: false, 
                blackjack: false, 
                displayedCards: 0,
                betAmount: currentBet,
                doubled: false,
                doubledCardIndex: -1,
                surrendered: false
            }];
            dealerHand = [];
            currentHandIndex = 0;
            gameActive = true;
            awaitingFirstAction = true;
            displayedDealerCards = 0;
            splitAces = false;
            handWrappers = [];
            currentHandInitialEV = 0; // Reset EV for the hand

            // Deduct initial bet
            bankroll -= currentBet;
            updateStats();
            updateChipStates(); // Disable chips during active game

            // Clear the displays
            document.getElementById('dealer-hand').innerHTML = '';
            document.getElementById('player-hands-container').innerHTML = '';

            // Deal initial cards
            playerHands[0].cards.push(dealCard());
            dealerHand.push(dealCard());
            playerHands[0].cards.push(dealCard());
            dealerHand.push(dealCard(false)); // Hole card - don't count until revealed

            updateDisplay();
            
            // --- ADDED: EV Calculation ---
            // Must happen *after* cards are dealt but *before* blackjack check
            const initialEV = getInitialEV(playerHands[0].cards, dealerHand[0]);
            currentHandInitialEV = initialEV * currentBet; // Store the $EV
            cumulativeEV += currentHandInitialEV;
            // --- END: EV Calculation ---


            // Check for blackjacks
            const playerCalc = calculateHand(playerHands[0].cards);
            const dealerCalc = calculateHand(dealerHand);
            
            // Dealer peeks for blackjack when showing Ace or 10
            const dealerUpCard = dealerHand[0];
            const shouldPeek = dealerUpCard.value === 'A' || dealerUpCard.numValue === 10;
            
            if (shouldPeek && dealerCalc.total === 21) {
                // Dealer has blackjack - reveal it immediately
                gameActive = false;
                updateDisplay();
                
                if (playerCalc.total === 21) {
                    showMessage('Push! Both have Blackjack.', 'warning');
                    bankroll += currentBet; // Return bet
                    
                    // --- ADDED: Graph update for Push ---
                    // netProfit is 0 (bet was -100, returned +100)
                    cumulativeProfit += 0;
                    updateGraphs(0, currentHandInitialEV);
                    // --- END: Graph update ---
                    
                } else {
                    showMessage('Dealer Blackjack! You lose $' + currentBet, 'error');
                    // Bet already deducted
                    
                    // --- ADDED: Graph update for Loss ---
                    // netProfit is -100 (bet was -100, got 0 back)
                    cumulativeProfit -= currentBet;
                    updateGraphs(-currentBet, currentHandInitialEV);
                    // --- END: Graph update ---
                }
                
                handsPlayed++;
                updateStats();
                updateChipStates(); // Re-enable chips after hand ends
                updatePresetBet(); // Recalculate bet for next hand if preset enabled
                document.getElementById('new-hand-btn').disabled = false;
                
                // Auto-deal if enabled
                if (autoDealEnabled && currentBet > 0 && bankroll >= currentBet) {
                    setTimeout(() => startNewHand(), redealSpeed);
                }
                return;
            }
            
            // Check for player blackjack (dealer doesn't have it)
            if (playerCalc.total === 21) {
                playerHands[0].blackjack = true;
                handlePlayerBlackjack();
                return;
            }

            // Enable appropriate buttons
            updateButtonStates();

            showMessage('Make your play based on Basic Strategy!', 'info');
            
            // Check if this hand qualifies for auto-play
            setTimeout(() => {
                let autoAction = checkAutoPlayEasyHand();
                if (!autoAction) {
                    autoAction = checkAutoPlayMediumHand();
                }

                // New check for Auto Play Hits
                if (!autoAction && checkAutoPlayHits()) {
                    return; // The auto-play is being handled by autoHitLoop
                }
                
                if (autoAction) {
                    showMessage('Auto-playing: ' + autoAction.toUpperCase(), 'info');
                    setTimeout(() => {
                        playerAction(autoAction, true); // true = skip correct/incorrect tracking
                    }, 500);
                }
            }, 100);
        }

        function handlePlayerBlackjack() {
            gameActive = false;
            updateDisplay();

            // Dealer doesn't have blackjack (already checked in startNewHand)
            // Player blackjack pays 3:2 - return original bet plus 1.5x winnings
            const payout = currentBet * 2.5; // Original bet + 1.5x bet
            const winnings = currentBet * 1.5;
            bankroll += payout;
            showMessage('Blackjack! You win $' + winnings + '!', 'success');
            playWinSound();

            handsPlayed++;
            
            // --- ADDED: Graph update for Blackjack Win ---
            cumulativeProfit += winnings;
            updateGraphs(winnings, currentHandInitialEV);
            // --- END: Graph update ---
            
            updateStats();
            updateChipStates(); // Re-enable chips after hand ends
            updatePresetBet(); // Recalculate bet for next hand if preset enabled
            document.getElementById('new-hand-btn').disabled = false;

            // Auto-deal next hand if enabled
            if (autoDealEnabled && currentBet > 0 && bankroll >= currentBet) {
                setTimeout(() => {
                    startNewHand();
                }, redealSpeed);
            }
        }

        // Update button states based on current hand
        function updateButtonStates() {
            const currentHand = playerHands[currentHandIndex];
            
            // Can only split on first action, with 2 cards of same value, up to 4 hands total, and enough money
            canSplit = awaitingFirstAction && 
                       currentHand.cards.length === 2 && 
                       currentHand.cards[0].value === currentHand.cards[1].value && 
                       playerHands.length < 4 && 
                       bankroll >= currentBet;
            
            // Can double on first action with enough money (need to match current hand's bet)
            canDouble = awaitingFirstAction && bankroll >= currentHand.betAmount;
            
            document.getElementById('hit-btn').disabled = false;
            document.getElementById('stand-btn').disabled = false;
            document.getElementById('double-btn').disabled = !canDouble;
            document.getElementById('split-btn').disabled = !canSplit;
            document.getElementById('new-hand-btn').disabled = true;
        }

        // Player actions
        function playerAction(action, isAutoPlay = false) {
            if (!gameActive) return;

            const currentHand = playerHands[currentHandIndex];
            const correctAction = getCorrectAction();
            
            // Check if it's the correct play (only if not auto-playing)
            if (awaitingFirstAction && !isAutoPlay) {
                totalDecisions++;
                if (action === correctAction) {
                    correctPlays++;
                    playCorrectSound();
                    showMessage('‚úì Correct! ' + action.toUpperCase(), 'success');
                } else {
                    showMessage('‚úó Wrong! Should ' + correctAction.toUpperCase() + ', but you chose ' + action.toUpperCase(), 'error');
                    document.getElementById('game-container').classList.add('shake');
                    setTimeout(() => document.getElementById('game-container').classList.remove('shake'), 500);
                }
                awaitingFirstAction = false;
                updateStats();
            } else if (isAutoPlay) {
                // Still mark as not awaiting first action, but don't count it
                awaitingFirstAction = false;
            }

            // Execute action
            switch(action) {
                case 'surrender':
                    // Surrender: get back half the bet
                    currentHand.stood = true;
                    currentHand.surrendered = true;
                    bankroll += currentHand.betAmount * 0.5; // Get half back
                    updateStats();
                    updateDisplay();
                    moveToNextHand();
                    break;

                case 'hit':
                    currentHand.cards.push(dealCard());
                    updateDisplay();
                    
                    const playerCalc = calculateHand(currentHand.cards);
                    if (playerCalc.total > 21) {
                        currentHand.busted = true;
                        updateDisplay();
                        moveToNextHand();
                    } else if (playerCalc.total === 21) {
                        currentHand.stood = true;
                        moveToNextHand();
                    } else {
                        // Can't double or split after first action
                        canDouble = false;
                        canSplit = false;
                        document.getElementById('double-btn').disabled = true;
                        document.getElementById('split-btn').disabled = true;
                    }
                    break;

                case 'stand':
                    currentHand.stood = true;
                    updateDisplay();
                    moveToNextHand();
                    break;

                case 'double':
                    // Deduct the additional bet
                    if (bankroll >= currentHand.betAmount) {
                        bankroll -= currentHand.betAmount;
                        currentHand.betAmount *= 2;
                        currentHand.doubled = true;
                        currentHand.doubledCardIndex = currentHand.cards.length; // Mark the next card as doubled
                        updateStats();
                        
                        currentHand.cards.push(dealCard());
                        updateDisplay();
                        
                        const calc = calculateHand(currentHand.cards);
                        if (calc.total > 21) {
                            currentHand.busted = true;
                        } else {
                            currentHand.stood = true;
                        }
                        updateDisplay();
                        moveToNextHand();
                    }
                    break;

                case 'split':
                    if (playerHands.length < 4 && bankroll >= currentBet) {
                        // Deduct bet for new hand
                        bankroll -= currentBet;
                        updateStats();
                        
                        // Check if splitting aces
                        const isAces = currentHand.cards[0].value === 'A';
                        if (isAces) {
                            splitAces = true;
                        }
                        
                        // Create new hand with second card
                        const secondCard = currentHand.cards.pop();
                        
                        // Clear the current hand's display so it rebuilds with just one card
                        if (handWrappers[currentHandIndex]) {
                            const handDiv = handWrappers[currentHandIndex].querySelector('.hand');
                            handDiv.innerHTML = '';
                        }
                        currentHand.displayedCards = 0;
                        
                        playerHands.push({
                            cards: [secondCard], 
                            busted: false, 
                            stood: false, 
                            blackjack: false,
                            displayedCards: 0,
                            betAmount: currentBet,
                            doubled: false,
                            doubledCardIndex: -1,
                            surrendered: false
                        });
                        
                        // Deal one card to each hand
                        currentHand.cards.push(dealCard());
                        playerHands[playerHands.length - 1].cards.push(dealCard());
                        
                        updateDisplay();
                        
                        // If split aces, both hands are done
                        if (isAces) {
                            currentHand.stood = true;
                            playerHands[playerHands.length - 1].stood = true;
                            updateDisplay();
                            dealerPlay();
                        } else {
                            // Continue with current hand
                            awaitingFirstAction = true;
                            updateButtonStates();
                        }
                    }
                    break;
            }
        }

        function moveToNextHand() {
            currentHandIndex++;
            
            // Check if there are more hands to play
            if (currentHandIndex < playerHands.length) {
                const nextHand = playerHands[currentHandIndex];
                
                // If this hand is from split aces, it's automatically done
                if (splitAces) {
                    moveToNextHand();
                    return;
                }
                
                awaitingFirstAction = true;
                updateDisplay();
                updateButtonStates();
                showMessage(`Playing Hand ${currentHandIndex + 1}. Make your play!`, 'info');
                
                // Check if this hand qualifies for auto-play
                setTimeout(() => {
                    let autoAction = checkAutoPlayEasyHand();
                    if (!autoAction) {
                        autoAction = checkAutoPlayMediumHand();
                    }

                    // New check for Auto Play Hits
                    if (!autoAction && checkAutoPlayHits()) {
                        return; // The auto-play is being handled by autoHitLoop
                    }
                    
                    if (autoAction) {
                        showMessage(`Hand ${currentHandIndex + 1}: Auto-playing ` + autoAction.toUpperCase(), 'info');
                        setTimeout(() => {
                            playerAction(autoAction, true); // true = skip correct/incorrect tracking
                        }, 500);
                    }
                }, 100);
            } else {
                // All hands played, dealer's turn
                dealerPlay();
            }
        }

        function dealerPlay() {
            gameActive = false;
            updateDisplay();

            setTimeout(() => {
                let dealerCalc = calculateHand(dealerHand);
                
                const dealInterval = setInterval(() => {
                    dealerCalc = calculateHand(dealerHand);
                    
                    // Dealer hits on soft 17 (H17 rules)
                    if (dealerCalc.total < 17 || (dealerCalc.total === 17 && dealerCalc.soft)) {
                        dealerHand.push(dealCard());
                        updateDisplay();
                    } else {
                        clearInterval(dealInterval);
                        endHand();
                    }
                }, 600);
            }, 500);

            // Disable all action buttons
            document.getElementById('hit-btn').disabled = true;
            document.getElementById('stand-btn').disabled = true;
            document.getElementById('double-btn').disabled = true;
            document.getElementById('split-btn').disabled = true;
        }

        function endHand() {
            gameActive = false;
            handsPlayed++;

            const dealerCalc = calculateHand(dealerHand);
            let totalWinLoss = 0;
            let winCount = 0;
            let loseCount = 0;
            let pushCount = 0;
            let surrenderCount = 0;
            let totalInvested = 0;
            
            // Evaluate each hand
            playerHands.forEach((hand, index) => {
                const playerCalc = calculateHand(hand.cards);
                let handResult = '';
                let handWinLoss = 0;
                
                totalInvested += hand.betAmount;
                
                // Skip surrendered hands - already resolved
                if (hand.surrendered) {
                    surrenderCount++;
                    handWinLoss = hand.betAmount * 0.5; // Already added to bankroll
                    // Don't add to totalWinLoss since it was already added
                    return;
                }
                
                if (hand.busted) {
                    handResult = 'BUST';
                    handWinLoss = 0; // Already deducted
                    loseCount++;
                } else if (dealerCalc.total > 21) {
                    handResult = 'WIN';
                    handWinLoss = hand.betAmount * 2; // Return bet + winnings
                    winCount++;
                } else if (playerCalc.total > dealerCalc.total) {
                    handResult = 'WIN';
                    handWinLoss = hand.betAmount * 2; // Return bet + winnings
                    winCount++;
                } else if (playerCalc.total < dealerCalc.total) {
                    handResult = 'LOSE';
                    handWinLoss = 0; // Already deducted
                    loseCount++;
                } else {
                    handResult = 'PUSH';
                    handWinLoss = hand.betAmount; // Return bet
                    pushCount++;
                }
                
                totalWinLoss += handWinLoss;
            });
            
            bankroll += totalWinLoss;
            
            // Calculate net profit (what you got back minus what you invested)
            let netProfit = totalWinLoss - totalInvested + (surrenderCount * currentBet * 0.5);
            
            // --- ADDED: Graph update for completed hand ---
            cumulativeProfit += netProfit;
            updateGraphs(netProfit, currentHandInitialEV);
            // --- END: Graph update ---
            
            
            // Show result message
            let message = '';
            
            if (playerHands.length === 1) {
                const hand = playerHands[0];
                if (hand.surrendered) {
                    message = `Surrendered. Lost $${hand.betAmount * 0.5}`;
                } else if (winCount === 1) {
                    message = `You win $${hand.betAmount}!`;
                    playWinSound();
                } else if (loseCount === 1) {
                    message = `You lose $${hand.betAmount}`;
                } else {
                    message = 'Push! Bet returned.';
                }
            } else {
                const resultParts = [];
                if (winCount > 0) resultParts.push(`${winCount}W`);
                if (loseCount > 0) resultParts.push(`${loseCount}L`);
                if (pushCount > 0) resultParts.push(`${pushCount}P`);
                if (surrenderCount > 0) resultParts.push(`${surrenderCount}SUR`);
                
                message = resultParts.join('-') + '. ';
                if (netProfit > 0) {
                    message += `Net: +$${netProfit}`;
                    playWinSound();
                } else if (netProfit < 0) {
                    message += `Net: -$${Math.abs(netProfit)}`;
                } else {
                    message += 'Break even';
                }
            }
            
            showMessage(message, netProfit >= 0 ? 'success' : 'error');
            
            updateStats();
            updateChipStates(); // Re-enable chips after hand ends
            updatePresetBet(); // Recalculate bet for next hand if preset enabled
            document.getElementById('new-hand-btn').disabled = false;

            // Auto-deal next hand if enabled
            if (autoDealEnabled && currentBet > 0 && bankroll >= currentBet) {
                setTimeout(() => {
                    startNewHand();
                }, redealSpeed);
            }
        }

        function toggleAutoDeal() {
            autoDealEnabled = document.getElementById('auto-deal-checkbox').checked;
            if (autoDealEnabled && !gameActive && currentBet > 0 && bankroll >= currentBet) {
                // If turning on auto-deal and no game is active, start immediately
                setTimeout(() => {
                    if (!gameActive && autoDealEnabled) {
                        startNewHand();
                    }
                }, 500);
            }
        }

        function toggleAutoPlay() {
            autoPlayEasyHands = document.getElementById('auto-play-checkbox').checked;
        }

        function toggleAutoPlayMedium() {
            autoPlayMediumHands = document.getElementById('auto-play-medium-checkbox').checked;
        }

        function toggleAutoPlayHits() {
            autoPlayHits = document.getElementById('auto-play-hits-checkbox').checked;
        }

        function toggleHideTotals() {
            hideTotals = document.getElementById('hide-totals-checkbox').checked;
            updateDisplay(); // Refresh display to show/hide totals
        }
        
        function toggleBettingPreset() {
            bettingPresetEnabled = document.getElementById('betting-preset-checkbox').checked;
            const unitSizeContainer = document.getElementById('unit-size-container');
            const rampConfig = document.getElementById('betting-ramp-config');
            
            if (bettingPresetEnabled) {
                unitSizeContainer.style.display = 'flex';
                rampConfig.classList.add('visible');
                // Calculate and set initial bet based on current count
                updatePresetBet();
                // Disable manual chip betting
                updateChipStates();
                showMessage('KO Betting Preset enabled - bet automatically adjusted by count', 'info');
            } else {
                unitSizeContainer.style.display = 'none';
                rampConfig.classList.remove('visible');
                // Re-enable manual betting
                updateChipStates();
                showMessage('Manual betting enabled', 'info');
            }
        }
        
        function updateUnitSize() {
            const input = document.getElementById('unit-size-input');
            unitSize = parseInt(input.value) || 100;
            if (bettingPresetEnabled && !gameActive) {
                updatePresetBet();
            }
        }
        
        function updateBettingRamp() {
            // Read values from inputs and update the betting ramp
            bettingRamp[0].units = parseInt(document.getElementById('ramp-rc-5').value) || 1;
            bettingRamp[1].units = parseInt(document.getElementById('ramp-rc-4').value) || 2;
            bettingRamp[2].units = parseInt(document.getElementById('ramp-rc-3').value) || 3;
            bettingRamp[3].units = parseInt(document.getElementById('ramp-rc-2').value) || 4;
            bettingRamp[4].units = parseInt(document.getElementById('ramp-rc-1').value) || 6;
            bettingRamp[5].units = parseInt(document.getElementById('ramp-rc0').value) || 8;
            bettingRamp[6].units = parseInt(document.getElementById('ramp-rc1').value) || 10;
            bettingRamp[7].units = parseInt(document.getElementById('ramp-rc2').value) || 12;
            
            // Recalculate bet if preset is enabled and not in active game
            if (bettingPresetEnabled && !gameActive) {
                updatePresetBet();
            }
        }
        
        function toggleRampConfig() {
            const rampConfig = document.getElementById('betting-ramp-config');
            const toggleBtn = rampConfig.querySelector('.config-toggle-btn');
            
            if (rampConfig.querySelector('.ramp-grid').style.display === 'none') {
                rampConfig.querySelector('.ramp-grid').style.display = 'grid';
                toggleBtn.textContent = 'Hide Configuration';
            } else {
                rampConfig.querySelector('.ramp-grid').style.display = 'none';
                toggleBtn.textContent = 'Show Configuration';
            }
        }
        
        function updatePresetBet() {
            // Only update preset bet when not in an active game
            if (!bettingPresetEnabled || gameActive) return;
            
            currentBet = calculatePresetBet();
            updateBetDisplay();
        }
        
        function calculatePresetBet() {
            // Find the appropriate bet based on running count
            // The ramp is ordered from lowest to highest RC
            let units = bettingRamp[0].units; // Default to lowest bet
            
            for (let i = bettingRamp.length - 1; i >= 0; i--) {
                if (koRunningCount >= bettingRamp[i].rc) {
                    units = bettingRamp[i].units;
                    break;
                }
            }
            
            return units * unitSize;
        }

        function updateRedealSpeed() {
            const slider = document.getElementById('redeal-speed-slider');
            redealSpeed = parseInt(slider.value);
            document.getElementById('slider-value').textContent = (redealSpeed / 1000).toFixed(1) + 's';
        }

        // Check if current hand qualifies for auto-play easy (only on first decision)
        function checkAutoPlayEasyHand() {
            if (!autoPlayEasyHands || !awaitingFirstAction) return null;
            
            const currentHand = playerHands[currentHandIndex];
            
            // Only works on initial two cards
            if (currentHand.cards.length !== 2) return null;
            
            const calc = calculateHand(currentHand.cards);
            const dealerUpCard = dealerHand[0].numValue === 11 ? 'A' : dealerHand[0].numValue;
            
            // Auto surrender - ONLY on initial hand before any splits
            // Cannot surrender after splitting
            if (playerHands.length === 1 && currentHandIndex === 0) {
                // Auto surrender hard 16 vs dealer 9, 10, A
                if (!calc.soft && calc.total === 16) {
                    if ([9, 10, 'A'].includes(dealerUpCard)) {
                        return 'surrender';
                    }
                }
                
                // Auto surrender hard 15 vs dealer 10
                if (!calc.soft && calc.total === 15) {
                    if (dealerUpCard === 10) {
                        return 'surrender';
                    }
                }
            }
            
            // Auto split aces
            if (currentHand.cards[0].value === 'A' && currentHand.cards[1].value === 'A') {
                if (canSplit) return 'split';
            }
            
            // Auto stand soft 20 (A,9)
            if (calc.soft && calc.total === 20) {
                return 'stand';
            }
            
            // Auto stand soft 19 if dealer doesn't have 6 (A,8)
            if (calc.soft && calc.total === 19 && dealerUpCard !== 6) {
                return 'stand';
            }
            
            // Auto stand hard 17, 18, 19, 20, 21
            if (!calc.soft && calc.total >= 17 && calc.total <= 21) {
                return 'stand';
            }
            
            return null;
        }

        // Check if current hand qualifies for auto-play medium (only on first decision)
        function checkAutoPlayMediumHand() {
            if (!autoPlayMediumHands || !awaitingFirstAction) return null;
            
            const currentHand = playerHands[currentHandIndex];
            
            // Only works on initial two cards
            if (currentHand.cards.length !== 2) return null;
            
            const calc = calculateHand(currentHand.cards);
            const dealerUpCard = dealerHand[0].numValue === 11 ? 'A' : dealerHand[0].numValue;
            
            // Don't auto-play pairs - they should be evaluated for splitting
            if (currentHand.cards[0].value === currentHand.cards[1].value) {
                return null;
            }
            
            // Auto stand hard 13-16 vs dealer 2-6 (stiff hands - stand hoping dealer busts)
            if (!calc.soft && calc.total >= 13 && calc.total <= 16) {
                if ([2, 3, 4, 5, 6].includes(dealerUpCard)) {
                    return 'stand';
                }
            }
            
            return null;
        }

        // Check if current hand qualifies for "Auto Play Hits"
        function checkAutoPlayHits() {
            if (!autoPlayHits || !awaitingFirstAction) return false;

            const currentHand = playerHands[currentHandIndex];
            
            // Only on initial two cards
            if (currentHand.cards.length !== 2) return false;
            
            const calc = calculateHand(currentHand.cards);
            const dealerUpValue = dealerHand[0].numValue;
            
            // Condition 1: Dealer shows 7 or up
            if (dealerUpValue < 7) return false;
            
            // Condition 2: Not a double opportunity (hard 10 or 11)
            if (!calc.soft && (calc.total === 10 || calc.total === 11)) return false;
            
            // Condition 3: Not a split opportunity
            if (canSplit) return false;
            
            // Condition 4: Player has hard 16 or less
            if (!calc.soft && calc.total <= 16) {
                // All conditions met. Start the auto-hit loop.
                showMessage(`Hand ${currentHandIndex + 1}: Auto-hitting vs ${dealerHand[0].value}`, 'info');
                
                // Mark as not awaiting first action so it doesn't get scored
                awaitingFirstAction = false;
                
                // Start the hit loop
                autoHitLoop(currentHand);
                return true; // Auto-play was triggered
            }
            
            return false;
        }

        function autoHitLoop(hand) {
            // Disable buttons during the loop
            document.getElementById('hit-btn').disabled = true;
            document.getElementById('stand-btn').disabled = true;
            document.getElementById('double-btn').disabled = true;
            document.getElementById('split-btn').disabled = true;
            
            const hitInterval = setInterval(() => {
                let calc = calculateHand(hand.cards);
                
                // Continue hitting if hard 16 or less
                if (!calc.soft && calc.total <= 16) {
                    hand.cards.push(dealCard());
                    updateDisplay();
                } else {
                    // Stop hitting
                    clearInterval(hitInterval);
                    
                    // Check bust or stand
                    calc = calculateHand(hand.cards); // re-calculate after last hit
                    if (calc.total > 21) {
                        hand.busted = true;
                    } else {
                        hand.stood = true; // Stood on 17+
                    }
                    updateDisplay();
                    moveToNextHand();
                }
            }, 600); // 600ms delay per hit
        }
        
        // Betting Control Functions
        function addChipToBet(amount) {
            // Don't allow betting during an active game
            if (gameActive) {
                showMessage('Cannot change bet during active hand', 'warning');
                return;
            }
            
            // Check if player has enough bankroll
            if (bankroll < currentBet + amount) {
                showMessage('Not enough bankroll!', 'error');
                return;
            }
            
            currentBet += amount;
            updateBetDisplay();
            playSound(600, 0.05); // Chip sound
        }
        
        function clearBet() {
            if (gameActive) {
                showMessage('Cannot change bet during active hand', 'warning');
                return;
            }
            
            currentBet = 0;
            updateBetDisplay();
        }
        
        function updateBetDisplay() {
            // During an active game, show the actual bet being played (from the hands)
            // Otherwise show the current bet for the next hand
            let displayAmount = currentBet;
            
            if (gameActive && playerHands.length > 0) {
                // Show the actual bet amount from the current hand being played
                displayAmount = playerHands.reduce((sum, hand) => sum + hand.betAmount, 0);
            }
            
            document.getElementById('current-bet-amount').textContent = '$' + displayAmount;
            updateChipStates();
            updateStats();
        }
        
        function updateChipStates() {
            // Disable chips if bankroll is too low or if game is active or if betting preset is enabled
            const chip25 = document.getElementById('chip-25');
            const chip100 = document.getElementById('chip-100');
            const chip500 = document.getElementById('chip-500');
            const clearBtn = document.getElementById('clear-bet-btn');
            
            if (gameActive || bettingPresetEnabled) {
                chip25.classList.add('chip-disabled');
                chip100.classList.add('chip-disabled');
                chip500.classList.add('chip-disabled');
                clearBtn.disabled = true;
            } else {
                // Enable/disable based on bankroll
                if (bankroll >= currentBet + 25) {
                    chip25.classList.remove('chip-disabled');
                } else {
                    chip25.classList.add('chip-disabled');
                }
                
                if (bankroll >= currentBet + 100) {
                    chip100.classList.remove('chip-disabled');
                } else {
                    chip100.classList.add('chip-disabled');
                }
                
                if (bankroll >= currentBet + 500) {
                    chip500.classList.remove('chip-disabled');
                } else {
                    chip500.classList.add('chip-disabled');
                }
                
                clearBtn.disabled = (currentBet === 0);
            }
        }

        function updateStats() {
            document.getElementById('bankroll').textContent = '$' + bankroll.toLocaleString();
            
            // Calculate total bet amount at risk
            const totalBetAmount = gameActive ? 
                playerHands.reduce((sum, hand) => sum + hand.betAmount, 0) : 
                currentBet;
            document.getElementById('current-bet').textContent = '$' + totalBetAmount;
            
            document.getElementById('hands-played').textContent = handsPlayed;
            document.getElementById('correct-plays').textContent = correctPlays + ' / ' + totalDecisions;
        }

        
        // --- ADDED: Graphing Functions ---
        
        /**
         * Gets the pre-calculated EV for the initial 2-card hand.
         * @param {Array} playerCards - The player's 2-card hand.
         * @param {Object} dealerUpCard - The dealer's up card.
         * @returns {number} The EV as a decimal (e.g., -0.541).
         */
        function getInitialEV(playerCards, dealerUpCard) {
            const calc = calculateHand(playerCards);
            let dealerVal = dealerUpCard.value;
            if (['J', 'Q', 'K'].includes(dealerVal)) dealerVal = '10';

            // Check for Blackjack (not in EV table, custom value)
            if (calc.total === 21) {
                // If dealer also has A or 10, it's a push (EV 0)
                if (dealerUpCard.numValue >= 10) {
                    return 0.0;
                }
                // If dealer doesn't have A or 10, it's a 3:2 win (EV +1.5)
                return 1.5;
            }

            try {
                // Case 1: Pair
                if (playerCards[0].value === playerCards[1].value) {
                    let pairVal = playerCards[0].value;
                    if (['J', 'Q', 'K'].includes(pairVal)) pairVal = '10';
                    return evTable.pairs[pairVal][dealerVal];
                }

                // Case 2: Soft Hand
                if (calc.soft) {
                    return evTable.soft[`${calc.total}`][dealerVal];
                }

                // Case 3: Hard Hand
                return evTable.hard[`${calc.total}`][dealerVal];

            } catch (e) {
                console.error(`Could not find EV for:`, calc, `vs`, dealerVal, e);
                return 0; // Default to 0 EV if lookup fails
            }
        }

        /**
         * Updates the two variance charts with the latest hand data.
         * @param {number} handProfit - The net profit/loss from the last hand.
         * @param {number} handEV - The initial $EV of the last hand.
         */
        function updateGraphs(handProfit, handEV) {
            // UPDATED: Removed check for handOutcomeChart
            if (!sessionVarianceChart) return;

            // 1. Update Session Variance Line Chart
            sessionVarianceChart.data.labels.push(handsPlayed);
            sessionVarianceChart.data.datasets[0].data.push(cumulativeProfit);
            sessionVarianceChart.data.datasets[1].data.push(cumulativeEV);
            
            // Limit to 100 hands on chart to prevent clutter
            if (sessionVarianceChart.data.labels.length > 100) {
                sessionVarianceChart.data.labels.shift();
                sessionVarianceChart.data.datasets.forEach(dataset => dataset.data.shift());
            }
            sessionVarianceChart.update('none'); // 'none' for no animation

            // 2. REMOVED: Scatter Plot update logic
        }

        /**
         * Creates and configures the charts on page load.
         */
        function initializeGraphs() {
            const lineCtx = document.getElementById('session-variance-chart').getContext('2d');
            // UPDATED: Removed scatterCtx
            
            Chart.defaults.color = '#d4af37';
            Chart.defaults.borderColor = 'rgba(212, 175, 55, 0.2)';

            // Master KPI: Session Variance (Line)
            sessionVarianceChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Actual P/L',
                            data: [],
                            borderColor: '#90ee90',
                            backgroundColor: '#90ee90',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 1
                        },
                        {
                            label: 'Expected P/L (EV)',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: '#ff6b6b',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: 1,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    scales: {
                        y: {
                            ticks: { callback: value => '$' + value },
                            grid: { color: 'rgba(212, 175, 55, 0.1)' }
                        },
                        x: {
                            title: { display: true, text: 'Hands Played' },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });

            // UPDATED: REMOVED Scatter chart initialization
        }
        // --- END: Graphing Functions ---


        // Initialize
        createDeck();
        updateStats();
        updateBetDisplay(); // Initialize betting display
        initializeGraphs(); // ADDED: Initialize charts
    </script>
</body>
</html>
